import React, { useMemo, useState } from "react";
import {
  Bar,
  BarChart,
  CartesianGrid,
  Line,
  LineChart,
  ResponsiveContainer,
  Tooltip,
  XAxis,
  YAxis,
} from "recharts";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

// Single-file dashboard component (Recharts + shadcn/ui + Tailwind)
// Drop into a Vite+React project (see chat instructions).

const rand = (min: number, max: number) => Math.round(min + Math.random() * (max - min));

type AuditRow = {
  id: string;
  date: string;
  banner: string;
  store: string;
  rep: string;
  forwardShare: number;
  stockPressure: number;
  oosPct: number;
  salesZAR: number;
};

const BANNERS = ["Banner A", "Banner B", "Banner C"];
const REPS = ["REP001", "REP002", "REP003", "REP004", "REP005"]; 
const STORES = [
  "Cape Town CBD",
  "Sea Point",
  "Claremont",
  "Bellville",
  "Somerset West",
  "Stellenbosch",
  "Paarl",
  "Durbanville",
];

function isoDate(d: Date) {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function makeFakeRows(count = 60): AuditRow[] {
  const today = new Date();
  const rows: AuditRow[] = [];
  for (let i = 0; i < count; i++) {
    const dt = new Date(today);
    dt.setDate(today.getDate() - i);
    const banner = BANNERS[i % BANNERS.length];
    const store = STORES[i % STORES.length];
    const rep = REPS[i % REPS.length];
    const forwardShare = rand(1, 5);
    const stockPressure = rand(1, 5);
    const oosPct = rand(0, 22);
    const salesZAR = rand(9000, 38000);

    rows.push({
      id: `AUD-${String(count - i).padStart(4, "0")}`,
      date: isoDate(dt),
      banner,
      store,
      rep,
      forwardShare,
      stockPressure,
      oosPct,
      salesZAR,
    });
  }
  return rows;
}

function mean(xs: number[]) {
  if (!xs.length) return 0;
  return xs.reduce((a, b) => a + b, 0) / xs.length;
}

function clamp(n: number, a: number, b: number) {
  return Math.max(a, Math.min(b, n));
}

export default function AuditDashboard() {
  const [rows] = useState<AuditRow[]>(() => makeFakeRows(90));

  // Filters
  const [banner, setBanner] = useState<string>("All");
  const [rep, setRep] = useState<string>("All");
  const [days, setDays] = useState<number>(30);

  const filtered = useMemo(() => {
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days + 1);

    return rows.filter((r) => {
      const okBanner = banner === "All" || r.banner === banner;
      const okRep = rep === "All" || r.rep === rep;
      const okDate = new Date(r.date) >= cutoff;
      return okBanner && okRep && okDate;
    });
  }, [rows, banner, rep, days]);

  // KPI cards
  const kpis = useMemo(() => {
    const forward = mean(filtered.map((r) => r.forwardShare));
    const pressure = mean(filtered.map((r) => r.stockPressure));
    const oos = mean(filtered.map((r) => r.oosPct));
    const sales = filtered.reduce((a, r) => a + r.salesZAR, 0);

    // A made-up “Execution Index” in [0,100]
    const execution = clamp(
      20 * forward + 20 * pressure + (100 - 2.5 * oos) * 0.3,
      0,
      100
    );

    return {
      forward,
      pressure,
      oos,
      sales,
      execution,
      n: filtered.length,
    };
  }, [filtered]);

  // Graph 1: daily sales (line)
  const salesSeries = useMemo(() => {
    const m = new Map<string, number>();
    for (const r of filtered) {
      m.set(r.date, (m.get(r.date) ?? 0) + r.salesZAR);
    }
    return Array.from(m.entries())
      .map(([date, salesZAR]) => ({ date, salesZAR }))
      .sort((a, b) => a.date.localeCompare(b.date));
  }, [filtered]);

  // Graph 2: banner avg ratings (bar)
  const bannerSeries = useMemo(() => {
    const by = new Map<string, AuditRow[]>();
    for (const r of filtered) {
      const arr = by.get(r.banner) ?? [];
      arr.push(r);
      by.set(r.banner, arr);
    }
    return BANNERS.map((b) => {
      const arr = by.get(b) ?? [];
      const f = mean(arr.map((r) => r.forwardShare));
      const p = mean(arr.map((r) => r.stockPressure));
      return {
        banner: b,
        forwardShare: Number(f.toFixed(2)),
        stockPressure: Number(p.toFixed(2)),
      };
    });
  }, [filtered]);

  const topRows = useMemo(() => filtered.slice(0, 15), [filtered]);

  return (
    <div className="min-h-screen bg-slate-50">
      <div className="mx-auto max-w-6xl px-4 py-6">
        <header className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h1 className="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">
              FMCG Audit Dashboard
            </h1>
            <p className="text-slate-600">
              Fake data • Filters update KPIs, graphs, and table
            </p>
          </div>

          <div className="flex flex-wrap gap-2">
            <FilterPill
              label="Days"
              value={`${days}d`}
              options={[7, 14, 30, 60, 90].map((d) => ({
                key: String(d),
                label: `${d}d`,
                value: d,
              }))}
              onChange={(v) => setDays(v)}
            />

            <FilterPill
              label="Banner"
              value={banner}
              options={[{ key: "All", label: "All", value: "All" }, ...BANNERS.map((b) => ({ key: b, label: b, value: b }))]}
              onChange={(v) => setBanner(v)}
            />

            <FilterPill
              label="Rep"
              value={rep}
              options={[{ key: "All", label: "All", value: "All" }, ...REPS.map((r) => ({ key: r, label: r, value: r }))]}
              onChange={(v) => setRep(v)}
            />
          </div>
        </header>

        <section className="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
          <KpiCard title="Execution Index" value={`${kpis.execution.toFixed(0)}/100`} sub={`${kpis.n} audits`} />
          <KpiCard title="Avg Forward Share" value={kpis.forward.toFixed(2)} sub="1–5 rating" />
          <KpiCard title="Avg Stock Pressure" value={kpis.pressure.toFixed(2)} sub="1–5 rating" />
          <KpiCard title="Avg OOS" value={`${kpis.oos.toFixed(1)}%`} sub="out-of-stock" />
        </section>

        <section className="mt-6 grid grid-cols-1 gap-4 lg:grid-cols-2">
          <Card className="rounded-2xl shadow-sm">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-sm text-slate-600">Sales (ZAR)</div>
                  <div className="text-lg font-semibold text-slate-900">Daily sales trend</div>
                </div>
                <div className="text-sm text-slate-600">
                  Total: <span className="font-semibold text-slate-900">{kpis.sales.toLocaleString("en-ZA")}</span>
                </div>
              </div>

              <div className="mt-3 h-72">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={salesSeries} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" tick={{ fontSize: 12 }} minTickGap={20} />
                    <YAxis tick={{ fontSize: 12 }} />
                    <Tooltip />
                    <Line type="monotone" dataKey="salesZAR" strokeWidth={2} dot={false} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl shadow-sm">
            <CardContent className="p-4">
              <div>
                <div className="text-sm text-slate-600">Quality</div>
                <div className="text-lg font-semibold text-slate-900">Average ratings by banner</div>
              </div>

              <div className="mt-3 h-72">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={bannerSeries} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="banner" tick={{ fontSize: 12 }} />
                    <YAxis domain={[0, 5]} tick={{ fontSize: 12 }} />
                    <Tooltip />
                    <Bar dataKey="forwardShare" />
                    <Bar dataKey="stockPressure" />
                  </BarChart>
                </ResponsiveContainer>
              </div>

              <div className="mt-2 text-xs text-slate-600">
                Bars: Forward Share and Stock Pressure (1–5).
              </div>
            </CardContent>
          </Card>
        </section>

        <section className="mt-6">
          <Card className="rounded-2xl shadow-sm">
            <CardContent className="p-4">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <div className="text-sm text-slate-600">Audits</div>
                  <div className="text-lg font-semibold text-slate-900">Most recent</div>
                </div>
                <Button variant="secondary" className="rounded-2xl" onClick={() => {
                  // demo: export a CSV in-browser
                  const header = ["id","date","banner","store","rep","forwardShare","stockPressure","oosPct","salesZAR"].join(",");
                  const lines = filtered.map(r => [r.id,r.date,r.banner,r.store,r.rep,r.forwardShare,r.stockPressure,r.oosPct,r.salesZAR].join(","));
                  const blob = new Blob([header + "\n" + lines.join("\n")], { type: "text/csv;charset=utf-8" });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = "audits.csv";
                  a.click();
                  URL.revokeObjectURL(url);
                }}>
                  Export CSV
                </Button>
              </div>

              <div className="mt-4 overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="border-b">
                      <Th>Audit</Th>
                      <Th>Date</Th>
                      <Th>Banner</Th>
                      <Th>Store</Th>
                      <Th>Rep</Th>
                      <Th className="text-right">Forward</Th>
                      <Th className="text-right">Pressure</Th>
                      <Th className="text-right">OOS</Th>
                      <Th className="text-right">Sales</Th>
                    </tr>
                  </thead>
                  <tbody>
                    {topRows.map((r) => (
                      <tr key={r.id} className="border-b last:border-0 hover:bg-slate-50">
                        <Td className="font-medium text-slate-900">{r.id}</Td>
                        <Td>{r.date}</Td>
                        <Td>{r.banner}</Td>
                        <Td>{r.store}</Td>
                        <Td>{r.rep}</Td>
                        <Td className="text-right">{r.forwardShare}</Td>
                        <Td className="text-right">{r.stockPressure}</Td>
                        <Td className="text-right">{r.oosPct}%</Td>
                        <Td className="text-right">{r.salesZAR.toLocaleString("en-ZA")}</Td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="mt-3 text-xs text-slate-600">
                Showing {topRows.length} of {filtered.length} rows.
              </div>
            </CardContent>
          </Card>
        </section>
      </div>
    </div>
  );
}

function KpiCard({ title, value, sub }: { title: string; value: string; sub: string }) {
  return (
    <Card className="rounded-2xl shadow-sm">
      <CardContent className="p-4">
        <div className="text-sm text-slate-600">{title}</div>
        <div className="mt-1 text-2xl font-semibold text-slate-900">{value}</div>
        <div className="mt-1 text-xs text-slate-600">{sub}</div>
      </CardContent>
    </Card>
  );
}

function Th({ children, className = "" }: { children: React.ReactNode; className?: string }) {
  return (
    <th className={`px-3 py-2 text-left text-xs font-semibold text-slate-600 ${className}`}>
      {children}
    </th>
  );
}

function Td({ children, className = "" }: { children: React.ReactNode; className?: string }) {
  return (
    <td className={`px-3 py-2 text-slate-700 ${className}`}>
      {children}
    </td>
  );
}

function FilterPill<T>({
  label,
  value,
  options,
  onChange,
}: {
  label: string;
  value: string;
  options: { key: string; label: string; value: T }[];
  onChange: (v: T) => void;
}) {
  return (
    <div className="flex items-center gap-2 rounded-2xl bg-white px-3 py-2 shadow-sm border border-slate-200">
      <div className="text-xs font-semibold text-slate-600">{label}</div>
      <div className="flex gap-1">
        {options.map((o) => (
          <button
            key={o.key}
            className={`rounded-xl px-2 py-1 text-xs transition border ${
              String(value) === String(o.label)
                ? "bg-slate-900 text-white border-slate-900"
                : "bg-white text-slate-700 border-slate-200 hover:border-slate-300"
            }`}
            onClick={() => onChange(o.value)}
            type="button"
          >
            {o.label}
          </button>
        ))}
      </div>
    </div>
  );
}
